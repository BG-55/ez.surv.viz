#high_risk_only <- read_excel("high_risk_only.xlsx")
high_risk_only <- all_subjs %>% select(c(`Local Study ID`, `Date of HRF Diagnosis`:Notes))
full_new_all_subjs <- new_all_subjs %>% left_join(.,high_risk_only, by = 'Local Study ID') %>%
relocate(`Date of HRF Diagnosis`:Notes, .after = `Other high risk features (Yes, No)`) %>%
#Make a dummy birthday column to ensure correct column order
mutate(Birthday = NA) %>% relocate(Birthday, .after = `Other high risk features (Yes, No)`)
#Make Tables like Jie
library(gtsummary)
library(tidyverse)
library(flextable)
library(officedown)
library(officer)
size_tabs <- 9
library(readr)
library(readxl)
library(tidyverse)
library(survival)
library(ggsurvfit)
library(survminer)
library(gtsummary)
#BMT Indication (Fig 3.)
#Confirmed same as Jie if Filter time greater than 0 (00058)
#Find people who had a transplant
got_transplant <- full_new_all_subjs %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
pull(., var = `Local Study ID`)
only_transplant_no <- new_no_mdls_aml %>% filter(`Local study ID` %in% got_transplant) %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7,8,10,12)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Get transplant people from AML group
only_transplant_aml <- new_aml %>% filter(`Local study ID` %in% got_transplant) %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7:10)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Get transplant people from MDS group
only_transplant_mds <- new_mds %>% filter(`Local study ID` %in% got_transplant) %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 6:9)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Combine them all together
only_transplant_dat <- rbind(only_transplant_no, only_transplant_aml,only_transplant_mds)
#Get transplant time and what the transplant was for
only_transplant_vars <- full_new_all_subjs %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local Study ID`,`Indication for Transplant (including  HRF)`)) %>%
rename(., id = 1, transplant_reason = 2)
#Add in the transplant reason variable and add survival analysis ready variables
#SDS1-000058 still has a negative time
#setdiff(only_transplant_dat$id,only_transplant_vars$id)
only_transplant_dat_new <- only_transplant_dat %>% left_join(.,only_transplant_vars, by = "id") %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(transplant_reason != "BMF" & transplant_reason != "Other") %>%
filter(time > 0) %>%
mutate(transplant_reason = factor(transplant_reason, levels = c("AML","MDS","HRF")))
#table(only_transplant_dat_new$transplant_reason)
fit2 <- survfit(Surv(time,status) ~ transplant_reason, data = only_transplant_dat_new)
ggsurvplot(fit2,xlab = "Survival Time After Transplant (Years)", legend.title = "",
size = 1, xlim = c(0,5), break.x.by = 1,
legend.labs = c("AML (N=10)","MDS (N=14)","HRF (N=15)"), palette =c("#E7B800", "#2E9FDF","#a2a1a1"),
pval = TRUE)
View(only_transplant_dat_new)
View(high_risk_only)
jrnery <- high_risk_only %>% filter(`Indication for Transplant (including  HRF)` == "HRF")
View(jrnery)
jrnery <- high_risk_only %>% filter(`Indication for Transplant (including  HRF)` == "HRF") %>%
pull(.,`Local Study ID`)
sum(jrnery %in% new_aml$`Local study ID`)
sum(jrnery %in% new_mds$`Local study ID`)
setdiff(jrnery,new_aml$`Local study ID`)
View(new_mds)
?ggsurvplot
View(only_transplant_dat_new)
?survfit
#Fig 4., age figure
#Filter out only people who were transplanted for HRF reasons and make indicator variable for people who got a BMT at older than 30
only_transplant_dat_only_hrf <- only_transplant_dat_new %>%
filter(transplant_reason == "HRF") %>% mutate(old_age = case_when(
age_at_bmt > 25 ~ "Older than 25 years old",
TRUE ~ "25 years old or younger"
))
fit3 <- survfit(Surv(time,status) ~ old_age, data = only_transplant_dat_only_hrf)
ggsurvplot(fit3,xlab = "Survival Time After Transplant (Years)", legend.title = "",
title = "Survival After BMT by Age (HRF Only)",
legend.labs = c(">25 yrs at transplant (non-missing=4)",
"<=25 yrs at transplant (non-missing=11)"), palette = c("red","black"),
pval = TRUE)
table(only_transplant_dat_new$transplant_reason)
#Fig 4., age figure
#Filter out only people who were transplanted for HRF reasons and make indicator variable for people who got a BMT at older than 30
only_transplant_dat_only_hrf <- only_transplant_dat_new %>%
filter(transplant_reason == "HRF") %>% mutate(old_age = case_when(
age_at_bmt > 25 ~ "Older than 25 years old",
TRUE ~ "25 years old or younger"
))
fit3 <- survfit(Surv(time,status) ~ old_age, data = only_transplant_dat_only_hrf)
ggsurvplot(fit3,xlab = "Survival Time After Transplant (Years)", legend.title = "",
title = "Survival After BMT by Age (HRF Only)",
legend.labs = c(">25 yrs at transplant (non-missing=4)",
"<=25 yrs at transplant (non-missing=11)"), palette = c("red","black"),
pval = TRUE)
ggrisktable(fit3)
?ggrisktable
#254 ppl bc of that seattle person switch
#All fiugres here are verified and good
#BMT
#Verified to get right columns
new_filt_no_bmt <- new_no_mdls_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`,7, 8,10,12)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_aml_bmt <- new_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7,8:10)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_mds_bmt <- new_mds  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 6,7:9)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Combine them together
new_filt_dat_bmt <- rbind(new_filt_aml_bmt, new_filt_no_bmt,new_filt_mds_bmt)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(!is.na(time)) %>%
filter(time > 0)
fit8 <- survfit(Surv(time,status) ~ 1, data = new_filt_dat_all_bmt)
ggsurvplot(fit8, conf.int = TRUE,
legend.title = "", legend.labs = c("BCH/Cincinnati"),conf.int.fill = "grey",
xlab = "Time Since BMT (Years)")
#254 ppl bc of that seattle person switch
#All fiugres here are verified and good
#BMT
#Verified to get right columns
new_filt_no_bmt <- new_no_mdls_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`,7, 8,10,12)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_aml_bmt <- new_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7,8:10)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_mds_bmt <- new_mds  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 6,7:9)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Combine them together
new_filt_dat_bmt <- rbind(new_filt_aml_bmt, new_filt_no_bmt,new_filt_mds_bmt)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(!is.na(time)) %>%
filter(time > 0)
fit8 <- survfit(Surv(time,status) ~ 1, data = new_filt_dat_all_bmt)
ggsurvplot(fit8, conf.int = TRUE,
legend.title = "", legend.labs = c("BCH/Cincinnati"),conf.int.fill = "grey",
xlab = "Time Since BMT (Years)")
View(new_filt_dat_all_bmt)
table(new_filt_dat_bmt$age_at_bmt)
sum(!is.na(new_filt_dat_bmt$age_at_bmt))
View(new_filt_dat_bmt)
vb <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt))
vb <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt)) %>%
pull(.,id)
setdiff(only_transplant_dat$id,only_transplant_vars$id)
setdiff(vb,new_filt_dat_all_bmt$id)
dhv <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt))
View(dhv)
View(new_filt_dat_all_bmt)
View(full_new_all_subjs)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes")
View(new_filt_dat_all_bmt)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id")
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati"))
#254 ppl bc of that seattle person switch
#All fiugres here are verified and good
#BMT
#Verified to get right columns
new_filt_no_bmt <- new_no_mdls_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`,7, 8,10,12)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_aml_bmt <- new_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7,8:10)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_mds_bmt <- new_mds  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 6,7:9)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Combine them together
new_filt_dat_bmt <- rbind(new_filt_aml_bmt, new_filt_no_bmt,new_filt_mds_bmt)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
#if there is an age of BMT, make it so transplant is true
#Caused by SDS1-000015 getting a BMT in between July and Oct datasets
mutate(`Transplant (Yes, No, NA/Unknown)` = case_when(
!is.na(age_at_bmt) ~ "Yes",
TRUE~ `Transplant (Yes, No, NA/Unknown)`
))
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(!is.na(time)) %>%
filter(time > 0)
#254 ppl bc of that seattle person switch
#All fiugres here are verified and good
#BMT
#Verified to get right columns
new_filt_no_bmt <- new_no_mdls_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`,7, 8,10,12)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_aml_bmt <- new_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7,8:10)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_mds_bmt <- new_mds  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 6,7:9)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Combine them together
new_filt_dat_bmt <- rbind(new_filt_aml_bmt, new_filt_no_bmt,new_filt_mds_bmt)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
#if there is an age of BMT, make it so transplant is true
#Caused by SDS1-000015 getting a BMT in between July and Oct datasets
mutate(`Transplant (Yes, No, NA/Unknown)` = case_when(
!is.na(age_at_bmt) ~ "Yes",
TRUE~ `Transplant (Yes, No, NA/Unknown)`
)) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(!is.na(time)) %>%
filter(time > 0)
fit8 <- survfit(Surv(time,status) ~ 1, data = new_filt_dat_all_bmt)
ggsurvplot(fit8, conf.int = TRUE,
legend.title = "", legend.labs = c("BCH/Cincinnati"),conf.int.fill = "grey",
xlab = "Time Since BMT (Years)")
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
#if there is an age of BMT, make it so transplant is true
#Caused by SDS1-000015 getting a BMT in between July and Oct datasets
mutate(`Transplant (Yes, No, NA/Unknown)` = case_when(
!is.na(age_at_bmt) ~ "Yes",
TRUE~ `Transplant (Yes, No, NA/Unknown)`
)) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(!is.na(time))
#254 ppl bc of that seattle person switch
#All fiugres here are verified and good
#BMT
#Verified to get right columns
new_filt_no_bmt <- new_no_mdls_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`,7, 8,10,12)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_aml_bmt <- new_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7,8:10)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_mds_bmt <- new_mds  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 6,7:9)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Combine them together
new_filt_dat_bmt <- rbind(new_filt_aml_bmt, new_filt_no_bmt,new_filt_mds_bmt)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
#if there is an age of BMT, make it so transplant is true
#Caused by SDS1-000015 getting a BMT in between July and Oct datasets
mutate(`Transplant (Yes, No, NA/Unknown)` = case_when(
!is.na(age_at_bmt) ~ "Yes",
TRUE~ `Transplant (Yes, No, NA/Unknown)`
)) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(!is.na(time)) %>%
filter(time > -0.0000001)
fit8 <- survfit(Surv(time,status) ~ 1, data = new_filt_dat_all_bmt)
ggsurvplot(fit8, conf.int = TRUE,
legend.title = "", legend.labs = c("BCH/Cincinnati"),conf.int.fill = "grey",
xlab = "Time Since BMT (Years)")
vb <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt)) %>%
pull(.,id)
setdiff(vb,new_filt_dat_all_bmt$id)
dhv <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt))
vb <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt)) %>%
pull(.,id)
setdiff(vb,new_filt_dat_all_bmt$id)
#254 ppl bc of that seattle person switch
#All fiugres here are verified and good
#BMT
#Verified to get right columns
new_filt_no_bmt <- new_no_mdls_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`,7, 8,10,12)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_aml_bmt <- new_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7,8:10)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_mds_bmt <- new_mds  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 6,7:9)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Combine them together
new_filt_dat_bmt <- rbind(new_filt_aml_bmt, new_filt_no_bmt,new_filt_mds_bmt)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
#if there is an age of BMT, make it so transplant is true
#Caused by SDS1-000015 getting a BMT in between July and Oct datasets
mutate(`Transplant (Yes, No, NA/Unknown)` = case_when(
!is.na(age_at_bmt) ~ "Yes",
TRUE~ `Transplant (Yes, No, NA/Unknown)`
)) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(!is.na(time)) %>%
#Weird filtering error for time = 0 subj, so we change this up to small negative number
filter(time > -0.0000001)
fit8 <- survfit(Surv(time,status) ~ 1, data = new_filt_dat_all_bmt)
ggsurvplot(fit8, conf.int = TRUE,
legend.title = "", legend.labs = c("BCH/Cincinnati"),conf.int.fill = "grey",
xlab = "Time Since BMT (Years)")
# vb <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt)) %>%
#   pull(.,id)
# setdiff(vb,new_filt_dat_all_bmt$id)
vb <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt)) %>%
pull(.,id)
setdiff(vb,new_filt_dat_all_bmt$id)
#Not BMT
#SDS1-000186 is late censor not in bc study site change
new_filt_dat_all <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
#if there is an age of BMT, make it so transplant is true
#Caused by SDS1-000015 getting a BMT in between July and Oct datasets
mutate(`Transplant (Yes, No, NA/Unknown)` = case_when(
!is.na(age_at_bmt) ~ "Yes",
TRUE~ `Transplant (Yes, No, NA/Unknown)`
)) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age ,
TRUE ~ alive_age
)) %>%
filter(!is.na(time)) %>%
filter(time > -0.0000001)
fit9 <- survfit(Surv(time,status) ~ 1, data = new_filt_dat_all)
ggsurvplot(fit9, conf.int = TRUE,
legend.title = "", legend.labs = c("BCH/Cincinnati"),conf.int.fill = "grey",
xlab = "Age (Years)")
#Not BMT
#SDS1-000186 is late censor not in bc study site change
new_filt_dat_all <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
#if there is an age of BMT, make it so transplant is true
#Caused by SDS1-000015 getting a BMT in between July and Oct datasets
mutate(`Transplant (Yes, No, NA/Unknown)` = case_when(
!is.na(age_at_bmt) ~ "Yes",
TRUE~ `Transplant (Yes, No, NA/Unknown)`
)) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age ,
TRUE ~ alive_age
)) %>%
filter(!is.na(time)) %>%
filter(time > -0.0000001)
fit9 <- survfit(Surv(time,status) ~ 1, data = new_filt_dat_all)
ggsurvplot(fit9, conf.int = TRUE,
legend.title = "", legend.labs = c("BCH/Cincinnati"),conf.int.fill = "grey",
xlab = "Age (Years)")
View(new_filt_dat_all)
#254 ppl bc of that seattle person switch
#All fiugres here are verified and good
#BMT
#Verified to get right columns
new_filt_no_bmt <- new_no_mdls_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`,7, 8,10,12)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_aml_bmt <- new_aml  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 7,8:10)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Verified to get right columns
new_filt_mds_bmt <- new_mds  %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
dplyr::select(c(`Local study ID`, 6,7:9)) %>%
rename(., id = 1, age_at_bmt = 2, alive_at_last = 3, alive_age = 4, dead_age = 5)
#Combine them together
new_filt_dat_bmt <- rbind(new_filt_aml_bmt, new_filt_no_bmt,new_filt_mds_bmt)
new_filt_dat_all_bmt <- new_filt_dat_bmt %>% right_join(.,full_new_all_subjs %>%
rename(id = `Local Study ID`), by = "id") %>%
filter(`Study site` %in% c("Boston","Cincinnati")) %>%
#if there is an age of BMT, make it so transplant is true
#Caused by SDS1-000015 getting a BMT in between July and Oct datasets
mutate(`Transplant (Yes, No, NA/Unknown)` = case_when(
!is.na(age_at_bmt) ~ "Yes",
TRUE~ `Transplant (Yes, No, NA/Unknown)`
)) %>%
mutate(
status = case_when(
alive_at_last == "No" ~ 1,
TRUE ~ 0),
time = case_when(
status == 1 ~ dead_age - age_at_bmt,
TRUE ~ alive_age - age_at_bmt
)) %>% filter(`Transplant (Yes, No, NA/Unknown)` == "Yes") %>%
filter(!is.na(time)) %>%
#Weird filtering error for time = 0 subj, so we change this up to small negative number
filter(time > -0.0000001)
fit8 <- survfit(Surv(time,status) ~ 1, data = new_filt_dat_all_bmt)
ggsurvplot(fit8, conf.int = TRUE, title = "Figure 7. Survival After BMT (N=",
legend.title = "", legend.labs = c("BCH/Cincinnati"),conf.int.fill = "grey",
xlab = "Time Since BMT (Years)")
# vb <- new_filt_dat_bmt %>% filter(!is.na(age_at_bmt)) %>%
#   pull(.,id)
# setdiff(vb,new_filt_dat_all_bmt$id)
setwd("C:/Users/CH244007/Documents/ez.surv.viz")
devtools::install()
